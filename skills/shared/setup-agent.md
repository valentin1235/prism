# Setup Agent Protocol

Shared module for delegating heavy early-phase computation to an isolated agent session. The setup agent runs all seed analysis, perspective generation, and ontology scope mapping, writes results to state files, and terminates — freeing its context entirely.

**Execution context:** This module can be executed by a setup agent spawned from any v2 skill orchestrator. The `{STATE_DIR}` parameter determines where output files are written.

**CRITICAL: The setup agent MUST be spawned as a foreground (blocking) subagent — do NOT use `run_in_background=true`.** Foreground subagents can use `AskUserQuestion` (passed through to the user). Background subagents cannot — `AskUserQuestion` calls will fail silently, breaking the entire setup flow.

## Table of Contents

- [Parameters](#parameters)
- [Phase S0: Read Skill Configuration](#phase-s0-read-skill-configuration)
- [Phase S1: Seed Analysis](#phase-s1-seed-analysis)
- [Phase S2: Perspective Approval](#phase-s2-perspective-approval)
- [Phase S3: Ontology Scope Mapping](#phase-s3-ontology-scope-mapping)
- [Phase S4: Context File](#phase-s4-context-file)
- [Phase S5: Sentinel File](#phase-s5-sentinel-file)
- [Output File Contract](#output-file-contract)
- [File Formats](#file-formats)

---

## Parameters

| Placeholder | Description | Examples |
|-------------|-------------|---------|
| `{SKILL_NAME}` | Which skill is invoking | `"plan"` / `"incident"` / `"prd"` |
| `{STATE_DIR}` | Absolute path to state directory | `.omc/state/plan-abc123/` |
| `{SHORT_ID}` | Session ID (already generated by caller) | `abc123` |
| `{INPUT_CONTEXT}` | Raw input from Phase 0 (goal/scope/constraints OR incident details OR PRD path) | varies |
| `{CALLER_CONTEXT}` | Label for ontology screens | `"analysis"` / `"incident analysis"` / `"PRD analysis"` |
| `{AVAILABILITY_MODE}` | Ontology MCP requirement level | `"optional"` / `"required"` |
| `{SKILL_PATH}` | Absolute path to the invoking SKILL.md file | `/path/to/skills/plan-v2/SKILL.md` |
| `{FAST_TRACK_ELIGIBLE}` | Whether fast track logic applies | `true` (incident-v2 only) / `false` (plan-v2, prd-v2) |

---

## Phase S0: Read Skill Configuration

Read `{SKILL_PATH}` to extract skill-specific configuration:

| Skill | Extract From SKILL.md |
|-------|----------------------|
| `plan` | Seed analysis dimensions (Step 1.1), perspective generation rules (Step 1.2), perspective quality gate reference |
| `incident` | Archetype Index (Core + Extended tables), Characteristic-to-Archetype Mapping table, perspective quality gate reference |
| `prd` | PRD perspective generation rules (Step 1.2), perspective quality gate reference |

This replaces passing large structured data as spawn parameters. The setup agent reads the SKILL.md directly and extracts what it needs.

---

## Phase S1: Seed Analysis

### Input Validation & Gap Filling

Before seed analysis, validate `{INPUT_CONTEXT}` completeness:

- **plan**: If required elements are missing (goal, scope, constraints), use `AskUserQuestion` per missing element to collect from user. Maximum 3 rounds. (Equivalent to plan-v2 Phase 0, Step 0.4.)
  - **Hell Mode**: If `{INPUT_CONTEXT}` contains `--hell` or `hell`, activate Hell Mode (unanimous consensus required). Record this flag in `context.md`.
- **incident**: If `{INPUT_CONTEXT}` is empty (no `$ARGUMENTS` provided), ask the user to describe the incident via `AskUserQuestion`: "Please describe the incident: What symptoms? Which systems affected? Business impact?" Then proceed to the Fast Track Check.
- **prd**: If `{INPUT_CONTEXT}` contains a file path, `Read` the PRD file. If file not found, error: "PRD file not found: {path}".

### Fast Track Check (only when `{FAST_TRACK_ELIGIBLE}=true`)

For incident-v2 only:
1. Collect severity and status via `AskUserQuestion`:
   - Severity → "SEV1 — Full outage" / "SEV2 — Partial degradation" / "SEV3 — Limited impact" / "SEV4 — Minor"
   - Status → "Active — Ongoing" / "Mitigated — Temp fix" / "Resolved — Postmortem" / "Recurring — Patterns"
   - Evidence (multiSelect) → "Logs & errors" / "Metrics/dashboards" / "Code changes" / "All of the above"
2. If SEV1 OR Active:
   - Set `track = FAST_TRACK`
   - Lock 4 core archetypes (Timeline + Root Cause + Systems + Impact) + DA
   - Skip Phase S2 (perspective approval)
   - Write locked 4-core roster to `{STATE_DIR}/perspectives.md` immediately (Phase S2 is skipped, but the file is required)
   - Determine ontology mapping: run Phase S3 by default. If urgency demands skipping, set `ONTOLOGY_SCOPE = "N/A — Fast Track, ontology mapping deferred."`
3. Otherwise: set `track = PERSPECTIVE_TRACK`, continue with normal flow

### Seed Analysis

Evaluate `{INPUT_CONTEXT}` across skill-specific dimensions (extracted from `{SKILL_PATH}` in Phase S0):

- **plan**: Evaluate across domain, complexity, risk profile, stakeholder count, timeline, novelty
- **incident**: Evaluate across domain, failure type, evidence available, complexity, recurrence. Map to archetype candidates using Characteristic-to-Archetype Mapping table.
- **prd**: Analyze PRD functional requirements. Read PRD file via `Read`. Also read sibling files (handoff, constraints) in the same directory.

Generate 3-6 orthogonal perspectives. Per perspective, define:
```
ID: {kebab-case-slug}
Name: {Human-readable perspective name}
Scope: {What this perspective examines}
Key Questions: [2-4 specific questions this perspective will answer]
Model: sonnet (standard) or opus (complex/cross-cutting)
Agent Type: {from SKILL.md archetype index or perspective rules}
Rationale: {1-2 sentences: why THIS input demands this perspective}
```

### Perspective Quality Gate

→ Apply `../shared/perspective-quality-gate.md` with skill-appropriate `{DOMAIN}` and `{EVIDENCE_SOURCE}`.

Write seed analysis results to `{STATE_DIR}/seed-analysis.md` (internal — not read by orchestrator).

---

## Phase S2: Perspective Approval

**Skipped on FAST_TRACK** (perspectives already locked in Phase S1).

### Language Detection

Detect report language:
1. **plan**: Detect from input content language
2. **incident**: Detect from user's input language
3. **prd**: Check if CLAUDE.md contains `Language` directive → use that. Otherwise detect from user's input language.

### Present Perspectives

`AskUserQuestion` (header: "Perspectives", question: "I recommend these {N} perspectives for analysis. How to proceed?", options: "Proceed" / "Add perspective" / "Remove perspective" / "Modify perspective")

### Iterate Until Approved

Repeat until user selects "Proceed". Warn if fewer than minimum perspectives for the skill.

### Lock Roster

Lock final perspective roster: ID, name, scope, key questions, model, agent type, rationale.

Write locked roster to `{STATE_DIR}/perspectives.md`.

---

## Phase S3: Ontology Scope Mapping

### Fast Track Decision

On FAST_TRACK (`{FAST_TRACK_ELIGIBLE}=true` and SEV1/Active detected):
- Default: Run ontology mapping normally (recommended even for fast track)
- If urgency demands skipping: Write fallback scope files and proceed

### Normal Execution

→ Read and execute `../shared/ontology-scope-mapping.md` with:
- `{AVAILABILITY_MODE}` = value from parameter
- `{CALLER_CONTEXT}` = value from parameter
- `{STATE_DIR}` = value from parameter

This executes the full ontology pool construction:
- All 3 AskUserQuestion screens (MCP data source selection, external source addition, pool confirmation)
- `ToolSearch(query="mcp", max_results=200)` for MCP discovery
- `WebFetch` for URL sources
- `Read` for file sources

Outputs (written by ontology-scope-mapping.md):
- `{STATE_DIR}/ontology-catalog.md`
- `{STATE_DIR}/ontology-scope-analyst.md`
- `{STATE_DIR}/ontology-scope-da.md`

### Required Mode Error Handling (prd-v2)

If `{AVAILABILITY_MODE}=required` and ontology-docs MCP is unavailable:
- The ontology-scope-mapping module will ERROR and STOP
- This error propagates to the setup agent
- The setup agent writes the error to `setup-complete.md` and terminates
- The orchestrator detects the error via sentinel file

---

## Phase S4: Context File

Write `{STATE_DIR}/context.md` with a structured summary for downstream agents:

| Skill | Content |
|-------|---------|
| `plan` | Goal, scope, constraints, stakeholders, success criteria, existing context, Hell Mode flag, report language |
| `incident` | Incident summary (symptoms, timeline, blast radius, mitigation, evidence), severity, status, evidence types, report language |
| `prd` | PRD summary (title, key functional requirements, non-functional requirements), PRD file path, sibling files summary, report language |

---

## Phase S5: Sentinel File (MUST BE LAST)

Write `{STATE_DIR}/setup-complete.md` as the **absolute last file**. This sentinel allows the orchestrator to distinguish complete setup from partial failure.

Content:
```markdown
# Setup Complete

## Timestamp
{ISO 8601 timestamp}

## Skill
{plan / incident / prd}

## Track
{FAST_TRACK / PERSPECTIVE_TRACK / N/A}

## Files Written
- perspectives.md
- context.md
- seed-analysis.md
- ontology-catalog.md (if applicable)
- ontology-scope-analyst.md (if applicable)
- ontology-scope-da.md (if applicable)

## Files Skipped
- {filename} — {reason, e.g. "Fast track: ontology mapping deferred"}
```

**Error format** (when setup fails, e.g., ontology required mode failure):

```markdown
# Setup Failed

## Timestamp
{ISO 8601 timestamp}

## Skill
{plan / incident / prd}

## Error
{error description, e.g. "ontology-docs MCP not configured. Required for PRD analysis."}

## Files Written Before Failure
- {any files successfully written before the error}

## Recommendation
{action for the user, e.g. "Run podo-plugin:install-docs to configure ontology-docs MCP."}
```

The setup agent MUST attempt to write the sentinel file even on error, so the orchestrator can distinguish "agent crashed" (no sentinel) from "setup failed with known error" (error sentinel).

**Terminate after writing sentinel file.**

---

## Output File Contract

| File | Content | Required |
|------|---------|----------|
| `{STATE_DIR}/seed-analysis.md` | Internal seed analysis results | YES (internal — not read by orchestrator) |
| `{STATE_DIR}/perspectives.md` | Locked perspective roster | YES |
| `{STATE_DIR}/context.md` | Extracted planning/incident/PRD context | YES |
| `{STATE_DIR}/ontology-catalog.md` | Pool catalog table | NO (skipped on fast track or MCP unavailable in optional mode) |
| `{STATE_DIR}/ontology-scope-analyst.md` | Analyst ontology scope block | NO (skipped on fast track or MCP unavailable in optional mode) |
| `{STATE_DIR}/ontology-scope-da.md` | DA ontology scope block | NO (skipped on fast track or MCP unavailable in optional mode) |
| `{STATE_DIR}/setup-complete.md` | Sentinel: lists files written/skipped | YES (always last) |

---

## File Formats

### perspectives.md

```markdown
# Perspectives — Locked Roster

## Report Language
{detected language}

## Track
{FAST_TRACK / PERSPECTIVE_TRACK / N/A}

## Perspectives

### {perspective-id}
- **Name:** {human-readable name}
- **Scope:** {what this perspective examines}
- **Key Questions:**
  1. {question 1}
  2. {question 2}
  3. {question 3}
- **Model:** {sonnet/opus}
- **Agent Type:** {agent type from SKILL.md}
- **Rationale:** {why this perspective is needed}

### {next-perspective-id}
...
```

#### incident-v2 additions:

```markdown
## Severity
{SEV1-4}

## Status
{Active/Mitigated/Resolved/Recurring}
```

#### prd-v2 additions:

```markdown
## PRD Path
{path to PRD file}

## PRD Sections per Perspective
### {perspective-id}
- PRD sections: {FR-N, NFR-N, etc.}
```

### context.md

Structured markdown with the fields listed in Phase S4. Format varies by skill.

### setup-complete.md

See Phase S5 for format specification.

---

## Exit Gate

MUST verify before terminating:

- [ ] `{SKILL_PATH}` read and configuration extracted (Phase S0)
- [ ] Seed analysis completed (Phase S1)
- [ ] Fast track decision made if `{FAST_TRACK_ELIGIBLE}=true` (Phase S1)
- [ ] Perspectives approved by user OR fast-track locked (Phase S2)
- [ ] `perspectives.md` written with valid roster
- [ ] Ontology scope mapping completed or explicitly skipped (Phase S3)
- [ ] `context.md` written with structured summary (Phase S4)
- [ ] `setup-complete.md` sentinel written as LAST file (Phase S5)
